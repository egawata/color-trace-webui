<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="wasm_exec.js"></script>
        <script>
            const go = new Go();
            WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject).then((result) => {
                go.run(result.instance);
            });
        </script>
        <style>
            .title{
                text-align: center;
            }
            .image {
                text-align: center;
            }
            canvas {
                border: 1px solid black;
                width: 400px;
                height: 400px;
            }
        </style>
    </head>
    <body>
        <div class="title">
            <h1>Color Trace Layer Generator</h1>
        </div>
        <div class="image">
            <div>Input</div>
            <img id="input-image" src="" alt="input image">
        </div>
        <div class="image">
            <div>Output</div>
            <img id="output-image" src="" alt="output image">
        </div>
        <div>
            <button id="fileselect">Select Image</button>
            <button id="generate">Generate</button>
        </div>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
    </body>
    <script>
        const fileInput = document.getElementById('file-input');
        const fileSelect = document.getElementById('fileselect');
        const generate = document.getElementById('generate');
        const inputImage = document.getElementById('input-image');
        const outputImage = document.getElementById('output-image');

        fileSelect.addEventListener('click', function() {
            fileInput.click();
        });

        fileInput.addEventListener('change', function() {
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                inputImage.src = e.target.result;
                var width = inputImage.width;
                var height = inputImage.height;
                if (width > height) {
                    height = 400 * height / width;
                    width = 400;
                } else {
                    width = 400 * width / height;
                    height = 400;
                }
                inputImage.style.width = width + 'px';
                inputImage.style.height = height + 'px';
            };
            reader.readAsDataURL(file);
        });

        generate.addEventListener('click', function() {
            /* TODO: implement here
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.src = inputImage.src;
            img.onload = function() {
                ctx.drawImage(img, 0, 0, 400, 400);
                const imageData = ctx.getImageData(0, 0, 400, 400);
                const data = new Uint8Array(imageData.data);
                const ptr = module._malloc(data.length);
                module.HEAPU8.set(data, ptr);
                const outputPtr = module._generate(ptr, 400, 400);
                const outputData = new Uint8Array(module.HEAPU8.buffer, outputPtr, 400 * 400 * 4);
                const outputImageData = new ImageData(new Uint8ClampedArray(outputData), 400, 400);
                ctx.putImageData(outputImageData, 0, 0);
                outputImage.src = canvas.toDataURL();
                module._free(ptr);
                module._free(outputPtr);
            };
            */
        });
    </script>
</html>